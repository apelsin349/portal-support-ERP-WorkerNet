# 🚀 Развертывание WorkerNet Portal

## Обзор

Этот документ описывает процесс развертывания WorkerNet Portal в продакшн среде. Система поддерживает развертывание на Ubuntu 24.04 LTS с использованием Docker и Docker Compose.

## Системные требования

### Минимальные требования
- **ОС**: Ubuntu 24.04 LTS
- **RAM**: 16+ GB (рекомендуется 32 GB для production)
- **CPU**: 8+ ядер (рекомендуется 16 для production)
- **Диск**: 200+ GB NVMe SSD
- **Сеть**: Стабильное интернет-соединение
- **Backup**: Автоматическое резервное копирование

### Программное обеспечение
- **Docker**: 24.0+
- **Docker Compose**: 2.20+
- **Python**: 3.11+
- **Node.js**: 18+
- **PostgreSQL**: 15+
- **Redis**: 7+
- **Nginx**: 1.24+

## Подготовка сервера

### 1. Обновление системы
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y curl wget git htop iotop fail2ban
```

### 2. Настройка файрвола
```bash
sudo ufw enable
sudo ufw allow 22      # SSH
sudo ufw allow 80      # HTTP
sudo ufw allow 443     # HTTPS
sudo ufw allow 3000    # Frontend
sudo ufw allow 8000    # API
```

### 3. Настройка Fail2ban
```bash
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
```

Добавить в `/etc/fail2ban/jail.local`:
```ini
[DEFAULT]
ignoreip = 127.0.0.1/8 ::1

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
```

```bash
sudo systemctl restart fail2ban
```

## Установка зависимостей

### 1. Docker и Docker Compose
```bash
# Удаляем старые версии
sudo apt remove -y docker docker-engine docker.io containerd runc

# Устанавливаем Docker
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# Добавляем пользователя в группу docker
sudo usermod -aG docker $USER

# Включаем автозапуск
sudo systemctl enable docker
sudo systemctl start docker
```

### 2. Python 3.11
```bash
sudo apt install -y python3.11 python3.11-venv python3.11-dev python3-pip
```

### 3. Node.js 18
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs
```

### 4. PostgreSQL 15
```bash
sudo apt install -y postgresql postgresql-contrib postgresql-client
sudo systemctl enable postgresql
sudo systemctl start postgresql
```

### 5. Redis 7
```bash
sudo apt install -y redis-server
sudo systemctl enable redis-server
sudo systemctl start redis-server
```

## Клонирование репозитория

```bash
cd /opt
sudo git clone https://github.com/apelsin349/portal-support-ERP-WorkerNet.git workernet
sudo chown -R $USER:$USER workernet
cd workernet
```

## Настройка окружения

### 1. Создание файла .env
```bash
cp env.example .env
```

Отредактируйте `.env`:
```env
# Основные настройки
SECRET_KEY=your-secret-key-here
DEBUG=False
ALLOWED_HOSTS=your-domain.com,www.your-domain.com

# База данных
DATABASE_URL=postgresql://workernet:your-db-password@localhost:5432/workernet

# Redis
REDIS_URL=redis://:your-redis-password@localhost:6379/0

# JWT
JWT_SECRET_KEY=your-jwt-secret-key

# Email (настройте для продакшна)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password

# Файлы
MEDIA_ROOT=/opt/workernet/media
STATIC_ROOT=/opt/workernet/static

# Мониторинг
SENTRY_DSN=your-sentry-dsn
```

### 2. Настройка базы данных
```bash
# Создание пользователя и базы данных
sudo -u postgres psql -c "CREATE USER workernet WITH PASSWORD 'your-db-password' CREATEDB SUPERUSER;"
sudo -u postgres psql -c "CREATE DATABASE workernet OWNER workernet;"
```

### 3. Настройка Redis
```bash
# Установка пароля для Redis
sudo sed -i 's/# requirepass foobared/requirepass your-redis-password/' /etc/redis/redis.conf
sudo systemctl restart redis-server
```

## Сборка и запуск

### 1. Сборка Docker образов
```bash
docker compose build
```

### 2. Запуск сервисов
```bash
docker compose up -d
```

### 3. Выполнение миграций
```bash
docker compose exec backend python manage.py migrate
```

### 4. Создание суперпользователя
```bash
docker compose exec backend python manage.py createsuperuser
```

### 5. Сбор статических файлов
```bash
docker compose exec backend python manage.py collectstatic --noinput
```

## Настройка Nginx

### 1. Установка Nginx
```bash
sudo apt install -y nginx
```

### 2. Создание конфигурации
```bash
sudo tee /etc/nginx/sites-available/workernet > /dev/null << 'EOF'
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # Редирект на HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL сертификаты
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # SSL настройки
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # Безопасность
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    
    # Размеры файлов
    client_max_body_size 10M;
    
    # Статические файлы
    location /static/ {
        alias /opt/workernet/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location /media/ {
        alias /opt/workernet/media/;
        expires 1y;
        add_header Cache-Control "public";
    }
    
    # API
    location /api/ {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # WebSocket
    location /ws/ {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Frontend
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF
```

### 3. Активация сайта
```bash
sudo ln -s /etc/nginx/sites-available/workernet /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## SSL сертификаты

### 1. Установка Certbot
```bash
sudo apt install -y certbot python3-certbot-nginx
```

### 2. Получение сертификата
```bash
sudo certbot --nginx -d your-domain.com -d www.your-domain.com
```

### 3. Автообновление
```bash
sudo crontab -e
```

Добавить:
```
0 12 * * * /usr/bin/certbot renew --quiet
```

## Мониторинг

### 1. Prometheus
```bash
# Установка Prometheus
wget https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz
tar xzf prometheus-2.45.0.linux-amd64.tar.gz
sudo mv prometheus-2.45.0.linux-amd64 /opt/prometheus

# Создание пользователя
sudo useradd --no-create-home --shell /bin/false prometheus
sudo chown -R prometheus:prometheus /opt/prometheus

# Создание systemd сервиса
sudo tee /etc/systemd/system/prometheus.service > /dev/null << 'EOF'
[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/opt/prometheus/prometheus --config.file /opt/prometheus/prometheus.yml --storage.tsdb.path /opt/prometheus/data --web.console.templates=/opt/prometheus/consoles --web.console.libraries=/opt/prometheus/console_libraries --web.listen-address=0.0.0.0:9090

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable prometheus
sudo systemctl start prometheus
```

### 2. Grafana
```bash
# Установка Grafana
wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
echo "deb https://packages.grafana.com/oss/deb stable main" | sudo tee /etc/apt/sources.list.d/grafana.list
sudo apt update
sudo apt install -y grafana

sudo systemctl enable grafana-server
sudo systemctl start grafana-server
```

## Резервное копирование

### 1. Скрипт резервного копирования
```bash
sudo tee /opt/backup-workernet.sh > /dev/null << 'EOF'
#!/bin/bash

BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# Создание директории
mkdir -p $BACKUP_DIR

# Резервное копирование базы данных
pg_dump -h localhost -U workernet workernet > $BACKUP_DIR/db_backup_$DATE.sql

# Резервное копирование файлов
tar -czf $BACKUP_DIR/files_backup_$DATE.tar.gz /opt/workernet/media /opt/workernet/static

# Удаление старых бэкапов (старше 30 дней)
find $BACKUP_DIR -name "*.sql" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

# Отправка в облако (опционально)
# aws s3 sync $BACKUP_DIR s3://your-backup-bucket/
EOF

sudo chmod +x /opt/backup-workernet.sh
```

### 2. Автоматическое резервное копирование
```bash
sudo crontab -e
```

Добавить:
```
0 2 * * * /opt/backup-workernet.sh
```

## Обновление системы

### 1. Скрипт обновления
```bash
sudo tee /opt/update-workernet.sh > /dev/null << 'EOF'
#!/bin/bash

cd /opt/workernet

# Создание резервной копии
/opt/backup-workernet.sh

# Обновление кода
git pull origin main

# Пересборка образов
docker compose build

# Перезапуск сервисов
docker compose down
docker compose up -d

# Выполнение миграций
docker compose exec backend python manage.py migrate

# Сбор статических файлов
docker compose exec backend python manage.py collectstatic --noinput

# Перезапуск Nginx
sudo systemctl reload nginx

echo "Обновление завершено!"
EOF

sudo chmod +x /opt/update-workernet.sh
```

## Проверка развертывания

### 1. Проверка сервисов
```bash
# Статус Docker контейнеров
docker compose ps

# Логи сервисов
docker compose logs backend
docker compose logs frontend

# Статус системных сервисов
sudo systemctl status nginx
sudo systemctl status postgresql
sudo systemctl status redis-server
```

### 2. Проверка доступности
```bash
# Проверка API
curl -I http://localhost:8000/api/

# Проверка Frontend
curl -I http://localhost:3000/

# Проверка Nginx
curl -I http://your-domain.com/
```

### 3. Проверка SSL
```bash
# Проверка SSL сертификата
openssl s_client -connect your-domain.com:443 -servername your-domain.com

# Проверка с помощью SSL Labs
# https://www.ssllabs.com/ssltest/
```

## Устранение неполадок

### 1. Проблемы с Docker
```bash
# Очистка Docker
docker system prune -a

# Перезапуск Docker
sudo systemctl restart docker
```

### 2. Проблемы с базой данных
```bash
# Проверка подключения
sudo -u postgres psql -c "\l"

# Проверка пользователей
sudo -u postgres psql -c "\du"
```

### 3. Проблемы с Nginx
```bash
# Проверка конфигурации
sudo nginx -t

# Перезапуск Nginx
sudo systemctl restart nginx

# Логи Nginx
sudo tail -f /var/log/nginx/error.log
```

## Безопасность

### 1. Обновление системы
```bash
# Регулярные обновления
sudo apt update && sudo apt upgrade -y

# Автоматические обновления безопасности
sudo apt install -y unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

### 2. Мониторинг безопасности
```bash
# Проверка открытых портов
sudo netstat -tlnp

# Проверка процессов
sudo ps aux | grep -E "(python|node|nginx|postgres|redis)"

# Проверка логов
sudo tail -f /var/log/auth.log
sudo tail -f /var/log/syslog
```

## Производительность

### 1. Оптимизация базы данных
```bash
# Анализ производительности
sudo -u postgres psql -d workernet -c "SELECT * FROM pg_stat_activity;"

# Очистка базы данных
sudo -u postgres psql -d workernet -c "VACUUM ANALYZE;"
```

### 2. Мониторинг ресурсов
```bash
# Использование CPU и памяти
htop

# Использование диска
iotop

# Сетевая активность
sudo netstat -i
```

---

## 🎯 Заключение

Развертывание WorkerNet Portal завершено! Система готова к работе в продакшн среде.

**Следующие шаги:**
1. Настройте мониторинг и алерты
2. Настройте резервное копирование
3. Проведите нагрузочное тестирование
4. Обучите команду поддержки
5. Создайте документацию для пользователей

**Важные ссылки:**
- Frontend: https://your-domain.com
- API: https://your-domain.com/api/
- Admin: https://your-domain.com/admin/
- Grafana: http://your-domain.com:3000
- Prometheus: http://your-domain.com:9090
 
### 3. Быстрая установка мониторинга через скрипт

В скрипте `scripts/install-ubuntu.sh` добавлена опциональная установка Prometheus и Grafana. По умолчанию включена.

```bash
# Установить с мониторингом (по умолчанию)
./scripts/install-ubuntu.sh

# Пропустить установку мониторинга
WORKERNET_INSTALL_MONITORING=0 ./scripts/install-ubuntu.sh

# Проверить статус после установки
sudo systemctl status prometheus grafana-server
curl -I http://localhost:9090
curl -I http://localhost:3000
```

**Поддержка:**
- Логи: `docker compose logs`
- Мониторинг: Grafana dashboard
- Резервные копии: `/opt/backups/`
- Обновления: `/opt/update-workernet.sh`
