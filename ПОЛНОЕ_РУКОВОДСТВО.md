# 🚀 Полное руководство WorkerNet Portal

## 📋 Содержание

### 🎯 Быстрый старт
- [Обзор системы](#обзор-системы)
- [Системные требования](#системные-требования)
- [Установка за 5 минут](#установка-за-5-минут)

### 🏗️ Развертывание
- [Подготовка сервера](#подготовка-сервера)
- [Установка зависимостей](#установка-зависимостей)
- [Настройка окружения](#настройка-окружения)
- [Сборка и запуск](#сборка-и-запуск)
- [Настройка Nginx и SSL](#настройка-nginx-и-ssl)
- [Мониторинг](#мониторинг)

### 🛠️ Разработка
- [Настройка среды разработки](#настройка-среды-разработки)
- [Структура проекта](#структура-проекта)
- [Backend разработка](#backend-разработка)
- [Frontend разработка](#frontend-разработка)
- [Git workflow](#git-workflow)

### 🏛️ Архитектура
- [Высокоуровневая архитектура](#высокоуровневая-архитектура)
- [Компоненты системы](#компоненты-системы)
- [Мультитенантность](#мультитенантность)
- [Безопасность](#безопасность)
- [Масштабируемость](#масштабируемость)

### 🎨 Современные практики
- [Архитектурные паттерны](#архитектурные-паттерны)
- [Инструменты разработки](#инструменты-разработки)
- [Методологии разработки](#методологии-разработки)
- [DevOps практики](#devops-практики)

### 🧪 Тестирование
- [Стратегия тестирования](#стратегия-тестирования)
- [Backend тестирование](#backend-тестирование)
- [Frontend тестирование](#frontend-тестирование)
- [E2E тестирование](#e2e-тестирование)
- [Нагрузочное тестирование](#нагрузочное-тестирование)

### 🔧 Устранение неполадок
- [Проблемы установки](#проблемы-установки)
- [Проблемы базы данных](#проблемы-базы-данных)
- [Проблемы производительности](#проблемы-производительности)
- [Проблемы безопасности](#проблемы-безопасности)
- [Диагностика](#диагностика)

### 📚 Дополнительно
- [Скрипты автоматизации](#скрипты-автоматизации)
- [Обновления](#обновления)
- [Резервное копирование](#резервное-копирование)
- [Интеграции](#интеграции)

---

## 🎯 Быстрый старт

### Обзор системы

WorkerNet Portal - это современная система технической поддержки, построенная на микросервисной архитектуре с использованием Django REST Framework, React и Docker.

**Основные возможности:**
- ✅ Управление тикетами и задачами
- ✅ Мультитенантность
- ✅ Real-time уведомления
- ✅ База знаний
- ✅ Аналитика и отчеты
- ✅ Мобильная поддержка
- ✅ API интеграции

### Системные требования

**Минимальные требования:**
- **ОС**: Ubuntu 22.04 LTS / 24.04 LTS
- **RAM**: 8+ GB (рекомендуется 16 GB для production)
- **CPU**: 4+ ядра (рекомендуется 8 для production)
- **Диск**: 50+ GB SSD (рекомендуется 100+ GB для production)
- **Сеть**: Стабильное интернет-соединение

**Программное обеспечение:**
- **Docker**: 24.0+
- **Docker Compose**: 2.20+
- **Python**: 3.11+
- **Node.js**: 18+
- **PostgreSQL**: 15+
- **Redis**: 7+
- **Nginx**: 1.24+

### Установка за 5 минут

```bash
# 1. Клонировать репозиторий
git clone https://github.com/apelsin349/portal-support-ERP-WorkerNet.git
cd portal-support-ERP-WorkerNet

# 2. Запустить автоматическую установку
bash scripts/install-ubuntu.sh

# 3. Создать администратора
docker compose exec backend python manage.py createsuperuser

# 4. Открыть в браузере
# Frontend: http://localhost:3000
# API: http://localhost:8000
# Admin: http://localhost:8000/admin
```

---

## 🏗️ Развертывание

### Подготовка сервера

#### 1. Обновление системы
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y curl wget git htop iotop fail2ban
```

#### 2. Настройка файрвола
```bash
sudo ufw enable
sudo ufw allow 22      # SSH
sudo ufw allow 80      # HTTP
sudo ufw allow 443     # HTTPS
sudo ufw allow 3000    # Frontend
sudo ufw allow 8000    # API
sudo ufw allow 9090    # Prometheus
sudo ufw allow 3001    # Grafana
sudo ufw allow 5555    # Celery Flower
sudo ufw allow 5601    # Kibana
sudo ufw allow 9200    # Elasticsearch
```

#### 3. Настройка Fail2ban
```bash
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo systemctl restart fail2ban
```

### Установка зависимостей

#### 1. Docker и Docker Compose
```bash
# Удаляем старые версии
sudo apt remove -y docker docker-engine docker.io containerd runc

# Устанавливаем Docker
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# Добавляем пользователя в группу docker
sudo usermod -aG docker $USER

# Включаем автозапуск
sudo systemctl enable docker
sudo systemctl start docker
```

#### 2. Python 3.11
```bash
sudo apt install -y python3.11 python3.11-venv python3.11-dev python3-pip
```

#### 3. Node.js 18
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs
```

### Настройка окружения

#### 1. Создание файла .env
```bash
cp env.example .env
nano .env
```

Пример `.env`:
```env
# Основные настройки
SECRET_KEY=your-secret-key-here
DEBUG=False
ALLOWED_HOSTS=your-domain.com,www.your-domain.com

# База данных
DATABASE_URL=postgresql://workernet:your-db-password@localhost:5432/workernet

# Redis
REDIS_URL=redis://:your-redis-password@localhost:6379/0

# JWT
JWT_SECRET_KEY=your-jwt-secret-key

# Email (настройте для продакшна)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password

# Файлы
MEDIA_ROOT=/opt/workernet/media
STATIC_ROOT=/opt/workernet/static

# Мониторинг
SENTRY_DSN=your-sentry-dsn
```

#### 2. Настройка базы данных
```bash
# Создание пользователя и базы данных
sudo -u postgres psql -c "CREATE USER workernet WITH PASSWORD 'your-db-password' CREATEDB SUPERUSER;"
sudo -u postgres psql -c "CREATE DATABASE workernet OWNER workernet;"
```

### Сборка и запуск

#### 1. Сборка Docker образов
```bash
docker compose build
```

#### 2. Запуск сервисов
```bash
docker compose up -d
```

#### 3. Проверка статуса
```bash
docker compose ps
```

#### 4. Выполнение миграций
```bash
docker compose exec backend python manage.py migrate
```

#### 5. Создание суперпользователя
```bash
docker compose exec backend python manage.py createsuperuser
```

#### 6. Сбор статических файлов
```bash
docker compose exec backend python manage.py collectstatic --noinput
```

### Настройка Nginx и SSL

#### 1. Установка Nginx
```bash
sudo apt install -y nginx
```

#### 2. Создание конфигурации
```bash
sudo tee /etc/nginx/sites-available/workernet > /dev/null << 'EOF'
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # Редирект на HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL сертификаты
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # SSL настройки
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # Безопасность
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    
    # Размеры файлов
    client_max_body_size 10M;
    
    # Статические файлы
    location /static/ {
        alias /opt/workernet/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location /media/ {
        alias /opt/workernet/media/;
        expires 1y;
        add_header Cache-Control "public";
    }
    
    # API
    location /api/ {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # WebSocket
    location /ws/ {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Frontend
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
EOF
```

#### 3. Активация сайта
```bash
sudo ln -s /etc/nginx/sites-available/workernet /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

#### 4. SSL сертификаты
```bash
# Установка Certbot
sudo apt install -y certbot python3-certbot-nginx

# Получение сертификата
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# Автообновление
sudo crontab -e
# Добавить: 0 12 * * * /usr/bin/certbot renew --quiet
```

### Мониторинг

#### 1. Prometheus
```bash
# Установка Prometheus
wget https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz
tar xzf prometheus-2.45.0.linux-amd64.tar.gz
sudo mv prometheus-2.45.0.linux-amd64 /opt/prometheus

# Создание пользователя
sudo useradd --no-create-home --shell /bin/false prometheus
sudo chown -R prometheus:prometheus /opt/prometheus

# Создание systemd сервиса
sudo tee /etc/systemd/system/prometheus.service > /dev/null << 'EOF'
[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/opt/prometheus/prometheus --config.file /opt/prometheus/prometheus.yml --storage.tsdb.path /opt/prometheus/data --web.console.templates=/opt/prometheus/consoles --web.console.libraries=/opt/prometheus/console_libraries --web.listen-address=0.0.0.0:9090

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable prometheus
sudo systemctl start prometheus
```

#### 2. Grafana
```bash
# Установка Grafana
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://apt.grafana.com/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/grafana.gpg
sudo chmod a+r /etc/apt/keyrings/grafana.gpg
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee /etc/apt/sources.list.d/grafana.list >/dev/null

sudo apt update
sudo apt install -y grafana

sudo systemctl enable grafana-server
sudo systemctl start grafana-server
```

#### 3. Проверка доступности
```bash
# Проверка сервисов
curl -I http://localhost:9090/  # Prometheus
curl -I http://localhost:3001/  # Grafana
curl -I http://localhost:5555/  # Celery Flower
curl -I http://localhost:5601/  # Kibana
```

**Важные ссылки:**
- Frontend: https://your-domain.com
- API: https://your-domain.com/api/
- Admin: https://your-domain.com/admin/
- Grafana: http://your-domain.com:3001
- Prometheus: http://your-domain.com:9090
- Celery Flower: http://your-domain.com:5555
- Kibana: http://your-domain.com:5601

---

## 🛠️ Разработка

### Настройка среды разработки

#### 1. Клонирование репозитория
```bash
# Клонировать репозиторий
git clone https://github.com/apelsin349/portal-support-ERP-WorkerNet.git
cd portal-support-ERP-WorkerNet

# Создать ветку для разработки
git checkout -b feature/your-feature-name
```

#### 2. Backend (Python/Django)
```bash
cd backend

# Создать виртуальное окружение
python3.11 -m venv venv
source venv/bin/activate  # Linux/macOS
# или
venv\Scripts\activate     # Windows

# Установить зависимости
pip install -r ../requirements.txt
pip install -r ../requirements-dev.txt
```

#### 3. Frontend (React/TypeScript)
```bash
cd frontend

# Установить зависимости
npm install

# Или с использованием yarn
yarn install

# Генерация иконок
npm run generate-icons
```

#### 4. Настройка базы данных
```bash
# Установить PostgreSQL
sudo apt install postgresql postgresql-contrib

# Создать пользователя и базу данных
sudo -u postgres psql -c "CREATE USER workernet WITH PASSWORD 'workernet123' CREATEDB SUPERUSER;"
sudo -u postgres psql -c "CREATE DATABASE workernet OWNER workernet;"
```

#### 5. Настройка Redis
```bash
# Установить Redis
sudo apt install redis-server

# Запустить Redis
sudo systemctl start redis-server
sudo systemctl enable redis-server
```

#### 6. Настройка окружения
```bash
# Скопировать файл окружения
cp env.example .env

# Отредактировать .env
nano .env
```

Пример `.env` для разработки:
```env
SECRET_KEY=development-secret-key
DEBUG=True
ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0
DATABASE_URL=postgresql://workernet:workernet123@localhost:5432/workernet
REDIS_URL=redis://localhost:6379/0
JWT_SECRET_KEY=development-jwt-secret
```

### Структура проекта

```
portal-support-ERP-WorkerNet/
├── backend/                 # Django backend
│   ├── app/                # Основное приложение
│   │   ├── models/         # Модели данных
│   │   ├── api/           # API endpoints
│   │   ├── core/          # Основная логика
│   │   └── ...
│   ├── config/            # Конфигурация Django
│   ├── manage.py          # Django management
│   └── ...
├── frontend/              # React frontend
│   ├── src/              # Исходный код
│   │   ├── components/   # React компоненты
│   │   ├── pages/        # Страницы
│   │   ├── hooks/        # Custom hooks
│   │   ├── utils/        # Утилиты
│   │   └── ...
│   ├── package.json      # Node.js зависимости
│   └── ...
├── scripts/              # Скрипты автоматизации
├── docker/              # Docker конфигурация
├── docs/               # Документация
└── ...
```

### Backend разработка

#### Запуск сервисов
```bash
cd backend
source venv/bin/activate

# Выполнить миграции
python manage.py migrate

# Создать суперпользователя
python manage.py createsuperuser

# Запустить сервер разработки
python manage.py runserver
```

#### Celery (фоновые задачи)
```bash
cd backend
source venv/bin/activate

# Запустить Celery worker
celery -A config worker -l info

# Запустить Celery beat (периодические задачи)
celery -A config beat -l info
```

### Frontend разработка

#### Запуск сервисов
```bash
cd frontend

# Запустить сервер разработки
npm run dev
# или
npm start

# Сборка для продакшна
npm run build
```

### Git workflow

#### Создание ветки
```bash
# Создать новую ветку
git checkout -b feature/new-feature

# Или из main
git checkout main
git pull origin main
git checkout -b feature/new-feature
```

#### Коммиты
```bash
# Добавить изменения
git add .

# Создать коммит
git commit -m "feat: добавить новую функцию"

# Push в удаленный репозиторий
git push origin feature/new-feature
```

#### Conventional Commits
```
feat: новая функция
fix: исправление бага
docs: изменения в документации
style: форматирование кода
refactor: рефакторинг
test: добавление тестов
chore: обновление зависимостей
```

**Полезные команды:**
- `python manage.py runserver` - Запуск backend
- `npm run dev` - Запуск frontend dev сервера
- `python manage.py test` - Запуск backend тестов
- `npm test` - Запуск frontend тестов
- `npm run build` - Сборка frontend для продакшна
- `docker compose up -d` - Запуск всех сервисов в Docker
- `docker compose logs -f` - Просмотр логов

---

## 🏛️ Архитектура

### Высокоуровневая архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                        Client Layer                             │
├─────────────────────────────────────────────────────────────────┤
│  Web App (React)  │  Mobile App  │  Admin Panel  │  API Clients │
└─────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────┐
│                      Load Balancer (Nginx)                     │
└─────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────┐
│                    Application Layer                            │
├─────────────────────────────────────────────────────────────────┤
│  Frontend (React)  │  Backend API (Django)  │  WebSocket (Channels) │
└─────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────┐
│                      Service Layer                              │
├─────────────────────────────────────────────────────────────────┤
│  Celery Workers  │  Celery Beat  │  Background Tasks  │  Notifications │
└─────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────┐
│                      Data Layer                                 │
├─────────────────────────────────────────────────────────────────┤
│  PostgreSQL  │  Redis  │  Elasticsearch  │  File Storage (S3)  │
└─────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────┐
│                    Monitoring Layer                             │
├─────────────────────────────────────────────────────────────────┤
│  Prometheus  │  Grafana  │  ELK Stack  │  Jaeger  │  AlertManager │
└─────────────────────────────────────────────────────────────────┘
```

### Компоненты системы

#### 1. Frontend (React)
- **Технологии**: React 18+, TypeScript, Material-UI, Zustand, React Query
- **Функции**: 
  - Пользовательский интерфейс
  - Управление тикетами
  - База знаний
  - Real-time уведомления
  - Административная панель
  - PWA поддержка
  - Мультиязычность

#### 2. Backend API (Django)
- **Технологии**: Django 4.2+, Django REST Framework, Django Channels, Celery
- **Функции**:
  - RESTful API
  - Аутентификация JWT
  - Мультитенантность
  - WebSocket поддержка
  - Административная панель
  - Фоновые задачи
  - API документация (Swagger/OpenAPI)

#### 3. База данных (PostgreSQL)
- **Функции**:
  - Основное хранилище данных
  - ACID транзакции
  - Индексы для производительности
  - Резервное копирование

#### 4. Кэш и очереди (Redis)
- **Функции**:
  - Кэширование сессий
  - Очереди задач Celery
  - Pub/Sub для WebSocket
  - Временное хранение данных

#### 5. Поиск и логирование (ELK Stack)
- **Elasticsearch**: Полнотекстовый поиск, аналитика и отчеты
- **Logstash**: Обработка и парсинг логов
- **Kibana**: Визуализация логов и аналитики

#### 6. Фоновые задачи (Celery)
- **Функции**:
  - Отправка email уведомлений
  - Обработка файлов
  - Генерация отчетов
  - Периодические задачи
  - Celery Beat для планировщика
  - Celery Flower для мониторинга

#### 7. Мониторинг
- **Prometheus**: Сбор метрик
- **Grafana**: Визуализация метрик и дашборды
- **ELK Stack**: Логирование и поиск
- **Celery Flower**: Мониторинг фоновых задач
- **Nginx**: Reverse proxy и балансировка нагрузки

### Мультитенантность

#### Стратегия изоляции
- **Shared Database, Shared Schema**: Все тенанты используют одну базу данных
- **Tenant ID**: Каждая запись содержит идентификатор тенанта
- **Middleware**: Автоматическая фильтрация по тенанту

#### Модель данных
```python
class Tenant(models.Model):
    name = models.CharField(max_length=100)
    slug = models.SlugField(unique=True)
    domain = models.CharField(max_length=100)
    is_active = models.BooleanField(default=True)

class Ticket(models.Model):
    tenant = models.ForeignKey(Tenant, on_delete=models.CASCADE)
    title = models.CharField(max_length=200)
    # ... другие поля
```

### Безопасность

#### Аутентификация
- **JWT токены**: Stateless аутентификация
- **Refresh токены**: Безопасное обновление токенов
- **2FA**: Двухфакторная аутентификация (опционально)

#### Авторизация
- **RBAC**: Роли и права доступа
- **Tenant isolation**: Изоляция данных между тенантами
- **API rate limiting**: Ограничение частоты запросов

#### Защита данных
- **HTTPS**: Шифрование трафика
- **Password hashing**: Безопасное хранение паролей
- **Input validation**: Валидация входных данных
- **SQL injection protection**: Защита от SQL инъекций

### Масштабируемость

#### Горизонтальное масштабирование
- **Load Balancer**: Распределение нагрузки
- **Multiple API instances**: Несколько экземпляров API
- **Database replication**: Репликация базы данных
- **Redis clustering**: Кластеризация Redis

#### Вертикальное масштабирование
- **Resource optimization**: Оптимизация ресурсов
- **Caching strategies**: Стратегии кэширования
- **Database indexing**: Индексы базы данных
- **Query optimization**: Оптимизация запросов

---

*Продолжение следует в следующих разделах...*
